# Code Review: `gasWbsTimelineViewAgent` vs. Spec v0.0.2

**Date:** 2026-01-30
**Reviewer:** Gemini CLI
**Documents:** `code.js`, `wbs-sheets-spec-v0.0.2.md`

---

## 1. Overall Summary

The `initializeWBSSystem` function in `code.js` provides a solid foundation for the project. It successfully implements the structural setup of the `wbs` and `holidays-tw` sheets as defined in the specification.

However, the current script **only handles the initial creation of the sheets**. It does not implement any of the key business logic, data automation, or validation rules required by the v0.0.2 specification. The script sets up the "stage," but the "actors" (the automated logic) are not yet present.

---

## 2. Alignment with Specification (What Works Well)

The script correctly implements the following aspects of the specification:

*   **Sheet Creation**:
    *   Successfully creates a `wbs` sheet.
    *   Correctly handles the naming convention for subsequent sheets (`wbs-1`, `wbs-2`, etc.) if the base `wbs` sheet already exists.
    *   Successfully creates the `holidays-tw` sheet if it is not already present.
*   **Column Structure**:
    *   The headers created in the `wbs` sheet (`Object`, `TaskTitle`, etc.) are a **perfect match** for the columns defined in the specification.
*   **Basic Formatting**:
    *   Applies the specified background color and bold font to header rows.
    *   Sets the correct `yyyy-mm-dd` number format for all date-related columns.
    *   Correctly freezes the header row for better usability.

---

## 3. Gaps and Deviations from Specification

The following critical business logic and automation rules from the specification are **not yet implemented** in the `code.js` script:

1.  **Automated `DueDate` Calculation**:
    *   **Spec Requirement**: `DueDate` must be automatically calculated based on `StartDate`, `WorkDays`, and the `holidays-tw` list.
    *   **Current State**: The script only formats the `DueDate` column as a date. There is no formula or script logic to perform the calculation.

2.  **Automated `TaskDescription-2` Generation**:
    *   **Spec Requirement**: `TaskDescription-2` must be automatically generated based on the format `[Resource]-TaskDescription-1` or `[未指派]-TaskDescription-1`.
    *   **Current State**: This is a blank column with no automated string formatting.

3.  **Default Values for New Rows**:
    *   **Spec Requirement**: The spec implies default values for several fields (`StartDate` defaults to today, `WorkDays` to 5, `TaskStatus` to 'NotStarted').
    *   **Current State**: The script sets up the sheet but does not populate new rows with any default values.

4.  **Data Validation and Enums**:
    *   **Spec Requirement**: The `TaskStatus` field is defined as an Enum (`NotStarted` / `InProgress` / `Done` / `Blocked`).
    *   **Current State**: The script does not apply any data validation rules to this column, meaning users can enter any text. A dropdown list would be ideal.

5.  **Consistency Logic**:
    *   **Spec Requirement**: A rule exists that links the `TaskStatus` of "Done" to the presence of a `DoneDate`.
    *   **Current State**: This logic is not implemented.

6.  **Duplication Prevention**:
    *   **Spec Requirement**: The spec calls for a "防重機制" (duplication prevention mechanism) based on the composite key of `Object` + `TaskTitle`.
    *   **Current State**: The initialization script does not (and likely should not) handle this. This logic would need to be part of a separate data entry or `onEdit` function.

---

## 4. Recommendations for Next Steps

To bring the script into full alignment with the v0.0.2 specification, the following steps are recommended:

1.  **Implement Logic with Sheet Formulas**: The most straightforward way to handle the automated calculations is to have the script insert formulas into the sheet by default.
    *   **For `DueDate`**: When creating the sheet, set a default formula in cell `I2` like `=IF(D2<>"", WORKDAY(D2, E2, 'holidays-tw'!A2:A), "")` and have it apply to the whole column.
    *   **For `TaskDescription-2`**: Similarly, set a formula in cell `J2` like `=IF(F2<>"", "["&F2&"]-"&C2, "[未指派]-"&C2)` and apply it down the column.

2.  **Use an `onEdit` Trigger**: For more complex, interactive logic like the consistency checks (Done status requires a `DoneDate`), an `onEdit(e)` trigger function would be more appropriate. This function can react when a user changes the `TaskStatus` column.

3.  **Add Data Validation**: During the `initializeWBSSystem` function, add data validation for the `TaskStatus` column.
    *   Example:
        ```javascript
        const rule = SpreadsheetApp.newDataValidation()
          .requireValueInList(['NotStarted', 'InProgress', 'Done', 'Blocked'])
          .build();
        newWbsSheet.getRange('G2:G').setDataValidation(rule);
        ```

4.  **Create a Separate Data Handling Function**: The duplication check should be part of a dedicated function for adding or updating data, rather than being part of the sheet initialization.

By focusing on these areas, the project can evolve from a structural setup script to a fully functional and automated project management tool as envisioned in the specification.
